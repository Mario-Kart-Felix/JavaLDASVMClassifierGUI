EMBEDDED SYSTEM DESIGN AND THE 
INTERNET OF THINGS 
PAT PANNUTO 
UNIVERSITY OF MICHIGAN 
INTERNET OF THINGS RESEARCH PROGRAM 
AUGUST 11, STANFORD UNIVERSITY 
Pat Pannuto 
3rd Year Ph.D. Student, 
University of Michigan 
•  BSE Computer Engineering, 
University of Michigan 
Research: 
•  Embedded systems, wireless 
technology, next-generation 
computing technologies 
•  “Last Inch” Problem 
Prabal Dutta 
Assistant Professor,    University of 
Michigan 
•  Ph.D. in CS from Berkeley, 2009 
Research: 
•  Networked embedded systems 
with applications to health, 
energy, and the environment 
Regrets he cannot be here 
Hosting a DARPA ISAT workshop 
2 
Lab11 at Michigan: 
(Some of) What we do 
eMbedded   Gateway  Cloud 
Lab11 at Michigan: 
(Some of) What we do 
eMbedded    
4 
Opo 
Goal: 
Explore methods to enable 
high spatiotemporal human 
interaction tracking 
Result: 
Novel ultrasonic wakeup 
circuit enables ~2 s granularity 
with ~5 cm accuracy for 1 
week on a 40 mAh battery 
1
2
4
3
0.
77
9 
m
0.
73
5 
m
0.789 m
0.789 m
1.11 m1
.0
2
 m
1.
7%
3.0%
2.9%
2.
5%
1
.6
%
0.5%
Lab11 at Michigan: 
(Some of) What we do 
eMbedded    
5 
Harmonia 
Goal: 
Rapid, high accuracy, indoor 
RF TDoA localization 
Track micro-quadcopters in real time 
Approach: 
UWB accuracy using NB 
frontends via impulses (TX) 
and band-stitching (RX) 
-50
 0
 50
 100
 150 -50
 0
 50
 100
 150-100
-50
 0
 50
 100
Lap Start
-50  0  50  100  150
-50
 0
 50
 100
 150
Lap Start
-50  0  50  100  150
-100
-50
 0
 50
 100
20 cm avg error 
40 cm 95%ile 
56 Hz samples 
Lab11 at Michigan: 
(Some of) What we do 
eMbedded    
6 
Monjolo Family 
Original Hypothesis: 
Estimate appliance energy 
use from side-channel 
emissions 
Result: 
Practical, battery-free* 
energy-harvesting sensors 
Lab11 at Michigan: 
(Some of) What we do 
eMbedded    
7 
Monjolo Family 
Original Hypothesis: 
Estimate appliance energy 
use from side-channel 
emissions 
Result: 
Practical, battery-free* 
energy-harvesting sensors 
Lab11 at Michigan: 
(Some of) What we do 
               Gateway   
Gen 1: Rpi + CC2520 
8 
“A necessary evil” 
Lab11 at Michigan: 
(Some of) What we do 
Gen 1: Rpi + CC2520 
Gen 2: BeagleBone Black 
+ 2 x CC2520 + CC2591 9 
               Gateway   “A necessary evil” 
That may be 
evolving into an 
interesting area of 
research 
Lab11 at Michigan: 
(Some of) What we do 
Gen 1: Rpi + CC2520 
Gen 2: BeagleBone Black 
+ 2 x CC2520 + CC2591 
Bluetooth 
Low Energy 
Smartphone 
as a gateway 
10 
               Gateway   “A necessary evil” 
That may be 
evolving into an 
interesting area of 
research 
Lab11 at Michigan: 
(Some of) What we do 
       Cloud 
GET 
ALL 
THE 
DATA 
Receiver
Queryer
Formatter
Archive
Processor
Streamer Client
11 
Never say “No” 
•  Collect and store all data, figure out 
what to do with it later 
Optimize for real-time / streaming 
•  Easy to archive a stream to more 
traditional DB for analysis 
Leverage “Web Scale” 
•  Enough technology exists to build 
highly scalable infrastructure quickly 
•  MongoDB + RabbitMQ + SocketIO 
Lab11 at Michigan: 
(Some of) What we do 
eMbedded   Gateway  Cloud 
Gen 1: Rpi + CC2520 
Gen 2: BeagleBone Black 
+ 2 x CC2520 + CC2591 
Embedded Systems 
Built in the last 365 days 
GET 
ALL 
THE 
DATA 
Bluetooth 
Low Energy 
Smartphone 
as a gateway 
Receiver
Queryer
Formatter
Archive
Processor
Streamer Client
12 
The Gateway Problem 
All 802.15.4 Gateways 
13 
The (mostly) universal gateway 
worked for WiFi, why not us? 
14 
A Trillion Sensors is a Trillion 
Batteries 
Claim 1 
 The majority of IoT devices in 
 5-10 years will be disposable 
Claim 2 
 5-10 years after that, many will be 
energy-harvesting, energy-neutral 
systems with “infinite” lifetimes 
15 
The lifetime of a disposable IoT 
device is defined by the energy it 
ships with (or can harvest) 
Thus, we need something more energy-efficient than 802.11 
But what? 
Self-Organizing (Sohrabi ’99), LEACH ’00, Adaptive Rate Control (Woo 
‘01), S-MAC ‘02, WiseMAC ‘04, B-MAC ‘04, Adaptive LPL ‘07, RI-MAC ‘08, 
A-MAC ‘10, GLOSSY ‘11,  LPB ‘12, Chaos ‘13, [To Appear: EkhoNet ’14]… 
ZigBee, 802.15.4e, CTP 
Best choice is system / application dependent 
+ Wakeup (“LPP”, Musaloiu-E. et al., IPSN’08) 
+ Discovery (“Disco”, Dutta et al., Sensys’08) 
+ Unicast (“RI-MAC”, Sun et al., Sensys’08) 
+ Broadcast (“ADB”, Sun et al., Sensys’09)  
+ Pollcast (“Pollcast”, Demirbas et al., INFOCOM’08)  
+ Anycast (“Backcast”, Dutta et al., HotNets’08)  
16 
Bluetooth Low Energy – A MAC 
convergence for non-mesh 
applications 
BLE doesn’t mesh, but many applications don’t need mesh – 
especially [primarily] collection-based ones 
17 
BLE as a backhaul for Personal 
Area Networks 
This is in commercial technology now 
Apps are emerging to provide other services as well 
Can this network reliably provide other, more demanding 
applications (e.g. firmware updates? + different class of trust 
for this application) 
18 
BLE as a backhaul for general sensor 
networks 
“Reverse Data Muling” 
Can smartphones + BLE act as a semi-universal gateway? 
Are there security concerns with auto-connecting to arbitrary 
Bluetooth devices? 
How does an embedded device trust arbitrary phones? 
Who pays for the data? Can this run as a carrier service? 
[Micropayments?] 
19 
The gateway problem is a 
fundamental problem 
Low-power IoT devices require low-power networks 
•  Which by their nature have limited range 
Something (gateway) must bridge a low-power network 
•  It is part of the architecture for good reason 
•  But it is burdensome in practice to deploy 
One Potential Plus 
•  Gateway as a privacy-preserving bottleneck 
20 
The Gateway Problem 
Nest Google Gets It 
Nest Products are Trojan Horse IoT Gateways 21 
Motivation for burdening the gateway 
node: Masking less-performant, less-
reliable low-power networks 
The Internet 
•  High bandwidth 
•  Reasonably low latency 
•  Reliable 
Low Power Networking 
Battery-backed 
•  Less bandwidth 
•  Higher latency  
•  Unreliable 
Energy-Harvesting 
•  Short Transmissions 
•  Minimal bandwidth 
•  Non-deterministic latency 
•  Highly Unreliable 
•  Possibly Unidirectional 
Low Power Networking 
Powered Devices 
•  Less bandwidth 
22 
Motivation for burdening the gateway 
node: Centralizing computation to 
minimize costs 
One :: Many 
Minimize Cost 
•  Limited 
computing power 
•  Limited program 
space, memory 
23 
A Case Study: 
The risks of relying on the gateway to 
be anything more than a gateway 
24 
Hue authentication: 
App to base station 
? 
? 
25 
Hue authentication: 
Base station to bulb 
Bulbs and base station ship pre-configured with shared secrets 
26 
Hue Security, OR 
end-to-end violation by example 
? 
Does this architecture guarantee that all commands 
are sent by an authorized owner of the light? 
27 
Any Hue bulb will trust any Hue 
base station 
http://www.zigbee.org/portals/0/documents/events/2012_04_26_ZLL-Green%20Lighting-Heile.pdf  
One master key shared by all Hue base stations 
28 
Bulbs and base station ship pre-configured with TWO shared secrets 
Two-level trust: 
Who’s trusted now and who to trust 
29 
The importance of understanding a 
threat model (and why what came 
before actually wasn’t so bad) 
http://www.zigbee.org/portals/0/documents/events/2012_04_26_ZLL-Green%20Lighting-Heile.pdf  
Reduces security to physical proximity (RSSI) 
30 
And then usability demanded an 
extension that makes it worse 
ArsTechnica, 5 Nov 2013: 
http://arstechnica.com/gadgets/2013/11/philips-hue-family-gets-brighter-with-new-type-of-light/  
Authenticate via 
immutable 6-digit bulb 
serial number 
Off-the-shelf ~40 ms per 
authentication attempt 
(due to slow web server) 
One-time cost to brute 
force: 
Just over a week 
31 
Embedded Device Design 
Small things without buttons 
32 
Why now? 
Why are so many IoT devices being built? 
What opened the floodgates? 
33 Google Ngram Viewer 
The smartphone is an embedded 
system and a micro-PC 
Very mature toolchains for 
embedded ARM cores  
34 
gcc 
clang msccv 
Driving down size, cost, and 
energy of peripheral sensors 
Wait, why do we need IoT if there 
are smartphones everywhere? 
35 
!= 
2 mm 
3.5 mm 0.5 mm 
!= 
A reminder: Energy is king 
36 
CAN ONLY 
Life Expectancy: 
40 mAh 
TI MSP430 
http://forum.allaboutcircuits.com/blog.php?b=551  
Moore’s Law 
Computing power in embedded 
Low power 32-bit microcontrollers becoming reality 
37 
Atmel SAM4L 
http://atmelcorporation.wordpress.com/2013/04/08/whats-new-in-
atmels-arm-mcu-picopower/  
Suvolta 
http://www.suvolta.com/technology/ddc/  
Moore’s Law and Memory 
SRAM hasn’t followed the same trend 
MSP430 
0.125-66 kB 
ST Micro STM32L 
4-80 kB 
38 
SRAM ceiling 
Atmel SAM4L 
32-64 kB 
NXP LPC1xxx 
1-36 kB 
Why has embedded memory size not 
followed the rest of computing? 
Q: Servers have terabytes of RAM, why is embedded memory 
following a slower trajectory? 
A1: Demand. Lower-performance cores restricted the scope of 
embedded applications, limiting demand for RAM. 
A2: Cost/Area. Don’t expect to improve on 6T / bit. 
Ultra-low power cells are even more demanding, e.g. 11T / bit. 
A3: Energy. SRAM contributes to static power of minimum 
(useful) power state 
39 
Some cautious SRAM Predictions 
It won’t get much bigger in the short term. 
Power-State Partitioned SRAM? 
Provides larger working set for applications, while enabling a 
minimum useful low power state 
The rise of FRAM. 
Replace “core” partition above with zero static power. 
e.g. TI’s Wolverine 
40 
What does all of this mean for 
security? Cryptography is 
computationally hard… 
41 
Didla et al., Optimizing AES for Embedded Devices and Wireless Sensor Networks 
https://engineering.purdue.edu/dcsl/presentations/2008/aes_tridentcom.pdf  
Cryptographic systems are designed 
with hardware acceleration in mind 
Sometimes you really need a Cup Holder. 
Atmel SAM4L AES-128 coprocessor – 11 cycles / block 
But how to actually USE it? 
1.  Ensure clock mask includes HSBMASK 
2.  Configure mode / other settings 
1.  §18.4.1-2 “Basic Programming and Operation”: 2 pages / 1200 words 
3.  DMA + Sleepwalking 
1.  Another dozen pages… 
42 
We solve these kind of problems 
with “drivers” 
Things are not so elegantly encapsulated in embedded systems 
43 
First-generation solved by Phil Levis 
TinyOS 2.0 abstracts resource management 
and peripheral power states 
Good enough for then, don’t handle now 
•  “Sleepwalking” 
•  Multi-clock options / decisions 
Open-problem in OS design 
Reasoning about performance at 
odds with security 
“Cup Holders” will actually save us 
Atmel SAM4L AES-128 coprocessor – 11 cycles / block 
But how to actually USE it? 
1.  Ensure clock mask includes HSBMASK 
2.  Configure mode / other settings 
1.  §18.4.1-2 “Basic Programming and Operation”: 2 pages / 1200 words 
3.  DMA + Sleepwalking 
1.  Another dozen pages… 
44 
Coprocessors can mean crypto 
libraries are less portable 
Existing software crypto libraries provide a good interface 
Q1: Does HW interface always match the “standard” SW interface? 
Q2: What accelerators are available? 
Q2.1: How do app developers say, 
 “I want ‘enough’, ‘efficient’ security” 
Q2.2: How to build heterogeneous networks with efficient crypto in the 
face of heterogeneous chips and co-processors? 
45 
A partial answer is provided by 
existing protocols 
Bluetooth Low Energy use AES-128-CCM for most operations 
And AES-128-CCM accelerators are available on every Bluetooth chip 
Master Key exchange is host-side and can change protocol 
This is an interoperability trade-off 
46 
Security vs Energy tradeoff. BLE 
requires out-of-band initial pairing to 
secure against eavesdroppers 
Association Models 
Bluetooth Smart (low energy) technology uses three association 
models referred to as Just Works, Out of Band and Passkey 
Entry. Bluetooth low energy technology does not have an 
equivalent of Numeric Comparison. Each of these association 
models is similar to Secure Simple Pairing with the following 
exception; Just Works and Passkey Entry do not provide any 
passive eavesdropping protection. This is because Secure 
Simple Pairing uses Elliptic Curve Diffie-Hellman and Bluetooth 
Smart (low energy) does not. The use of each association model 
is based on the I/O capabilities of the devices in a similar manner 
as Secure Simple Pairing. 
https://developer.bluetooth.org/TechnologyOverview/Pages/LE-Security.aspx 
47 
Not a good property for using smartphones 
as roving, universal gateways 
       
lab11.eecs.umich.edu 
48 
Hardware Takeaways 
Energy is king. 
Dictates system lifetime 
Computational power has come to embedded MCUs, but 
Application complexity limited by limited SRAM 
Hardware support can enable energy-efficient complex tasks 
Perhaps a sweet spot between ASIC and FPGAs {David Brooks} 
49 
THE PROBE INCOMPATIBILITY MESS 
Probes use hardware acknowledgements 
Probes do not use hardware acknowledgements 
Probes include only receiver-specific data 
Probes include sender-specific data too 
Probes include contention windows 
Probes do not include contention windows 
Pollcast 
RI-MAC LPP 
Backcast 
50 
Lab11 at Michigan: 
(Some of) What we do 
eMbedded    
Energy-Harvesting 
Embedded Systems 
Built in the last 365 days 
(credit: Brad Campbell) 
54 
Lab11 at Michigan: 
(Some of) What we do 
eMbedded    
Embedded Systems 
Built in the last 365 days 
55 

