XVIII IMEKO WORLD CONGRESS Metrology for a Sustainable Development September, 17  22, 2006, Rio de Janeiro, Brazil    MEASUREMENTS OF CIRCUIT FUNCTIONS OF ANALOG PARTS OF MIXEDSIGNAL SYSTEMS BY MICROCONTROLLERS  Zbigniew Czaja, Romuald Zielonko  Gdansk University of Technology, Faculty of Electronics, Telecommunications and Informatics, Department of Metrology and Electronic Systems, Gdansk, Poland, zbczajapg.gda.pl, zielonkoeti.pg.gda.pl    Abstract In the paper, two approaches to measurements of circuit functions of analog parts of mixedsignal systems controlled by microcontrollers are presented. They base on the utilization of internal resources of the microcontrollers. The first approach uses an analog to digital converter ADC, an analog comparator and a timer. The second one uses only the ADC and the timer. The measurement procedures are realized also by the microcontroller. As an example, the transfer voltage function of a circuit function was chosen.  Keywords fault diagnosis, mixedsignal systems, microcontrollers. 1.    INTRODUCTION The fast development of the telecommunications, multimedia and automobile markets which base on mixedsignal embedded systems causes increased interest in the diagnosis of analog parts of these systems. Often they have hardtested analog parts. It was reported 1 that in mixedsignal circuits, 95 of the test cost is expended on testing the analog parts, while the digital counterparts account for only 5 of the overall test cost. Hence, new methods enabling measurement and testing of analog parts of these systems are needed, especially using of BISTs, which minimalize test cost and guarantee high quality of products. Testing of analog parts is very difficult and not standardized, because analog circuits are very varied and they are applied in various applications. In addition, the offered BISTs are dedicated, only for selected few classes of circuits, e.g. adcBISTs for analog to digital converters 2, BISTs for fully differential circuits 3, BISTs based on the oscillationtest methodology for active analog filters 4, BISTs for opamps 5. An application of these BISTs introduces additional elements to the system, so it increases production costs. Hence, development of new measurement and testing methods simplifying the structure and design of BISTs, which allows to decrease costs, is needed. In the paper two new measurement methods satisfying the above requirements and an analysis of accuracy are presented. Thanks to these methods we can use the microcontroller mounted in the system its hardware resources and computing power to realize the BIST. In this way we obtain a reconfigurable BIST, which is created only during testing time. Hence, we considerably decrease the number of elements of the BIST which have to be added to the system. 2.    THE MEASUREMENT METHODS In the papers 6,7 real and imaginary parts of the circuits functions were measured in a standard way using a transmittance analyzer. Next, the measurement result the measurement point was placed on a map of identification curves Fig. 1 and fault localisation and identification were carried out. A particular identification curve li was drawn based on the transformation 21 ImRe ii iii pFpFpT  ,    1 where i1, i2  are versors, Fpi  a circuit function in relation to the value of the element pi.   Fig. 1.  A map of identification curves of the analog circuit from Fig. 2 for the voltage transfer function Ku The curves represent changes of values of particular elements from 0.1pi nom to 10pi nom, where pi nom  is nominal value of the ith element.  Fig. 2.  An example of the analog part where R1R25k, C122nF, C247nF 2.1. The method bases on the ADC, the analog comparator and the timer In the paper 8 a new way of measurement of the circuit functions using internal resources of the microcontroller was proposed. It was illustrated on the example of a transfer function. It is represented by values easilymeasured and simply computed by the microcontroller the voltage amplitude measured by the ADC representing the magnitude and the time delay measured by the timer the phase shift of an output signal of the tested analog circuit. The voltage amplitude, the voltage offset and the frequency of a stimulating signal are known and determined.   Fig. 3.  An example of the mixedsignal system where R1R25k, C122nF, C247nF for the first method In this case the identification curve li is described in the following way 8 1 21  ii iiOUTii ppUpT  ,    2 where UOUT i  the output voltage amplitude, i  time delay. For all pi elements of the tested circuit we obtain the family of identification curves shown in Fig. 4.  Fig. 4.  A map of identification curves of the analog circuit from Fig. 2 for the transformation 2 The measurement procedure consists of three parts 8 as shown in Fig. 5  measurement of the period T of the signal,  measurement of maximum voltage UOUT of the signal,  measurement of the time delay .   Fig. 5.  The timing of the measurement procedure  Details of this procedure are described in 8. It is realized by the microcontroller according to the timing shown in Fig. 5. A sine wave uIN is applied to the input of the analog part. Its output is connected to the input of the internal analog comparator and the input of the ADC. If the analog comparator detects a voltage greater than the threshold voltage UREF, it turns on the Timer 0, which counts 14 of the period T of the stimulus signal. The end of this time determines the moment of the measurement of voltage UOUT of the circuit response signal by the ADC. Next the stimulating signal is applied to the input of the analog comparator. Start of the analog comparator activates the measurement of time delay m. Measurement results of the voltage um and time delay m are stored in the form of single bytes. 2.2.  The method bases on the ADC and the timer The novelty of the paper is the new measurement method described in this paragraph. The method needs for the measurement of the circuit function only the ADC and the timer.  At present almost each modern microcontroller has an ADC and at least one timer. The analog comparator is contained in not numerous microcontrollers. Implementation of the previous method in microcontrollers without analog comparators requires to add an external analog comparator, which extends the BIST and increases its costs.  Fig. 6.  An example of the mixedsignal system where R1R25k, C122nF, C247nF fir the second method By giving up the analog comparator we simplify the BIST Fig. 6. However it is obtained by increased complexity of the measurement algorithm, because we have to deduce the voltage amplitude of the input and output signals and the time delay between these signals based only on voltage samples measured by the ADC at moments determined by the timer. Creating the measurement algorithm the following assumptions were made  To determine the amplitudes of stimulus uIN and response uOUT signals and the time delay m between them only the ADC is used, synchronized by the timer.  The algorithm should be simple as it is possible, because  its code has to occupy a small size in the program memory of the microcontroller, because this memory is already occupied by the main program controlling the work of the embedded system,  calculations should not be complicated. They should base on an integer addition, a subtraction and a rotation these operations are implemented as single assembler instructions, because the microcontrollers have small computing power.  The period T and the voltage offset Uoffset of the input stimuli signal are known.  Measured amplitudes are stored with 8bit resolution one byte, and the time delay m with 16bit resolution two bytes  the resolution of the Timer 1.  Fig. 7.  The idea of searching for the amplitude of the sine wave signal An idea of determination of the amplitude maximum value of the input signal and also the output signal is shown in Fig. 7. The amplitude is searched in a iterative way. Fig. 7 shows only four iterations of sampling of the signal. Moments of the samples are represented by arrows, where the first number is the iteration step, the second one is the number of the sample in the given iteration step. At the beginning of the algorithm of determination of the amplitude the ADC measures the first sample of the input stimulating signal in the first iteration step 1,1 at the random moment which is assumed as the reference moment for all the algorithm. The value T is written also to the variable tm which keeps relative time between moments of samples. In the next step 1,2 the ADC takes the sample at the moment tm  tm  td, where td  T4 in practice tm  tm  nT  td, to consider the long conversion time of the ADC, where n  1,2, ... If the voltage value at the moment 1,2 is smaller than the value at the moment 1,1, the td  td2 the right rotation instruction and direction of sampling is changed to the opposite in this case tm  tm  td. So, we start the second iteration  steps from 2,1 to 2,4. If the last voltage sample is smaller than the previous one, the algorithm goes to the next iteration step with td divided by two and changed direction of changes of the value tm. This procedure is repeated until, in the jth iteration step um j,k  um j, k  1  ud, where k  the number of the voltage sample in the jth iteration step, ud  assumed minimum difference between two last measured voltage samples, for which the algorithm is finished. We stored uIN  um j,k, and tIN  tm. Next, still to continue counting of the time tm by the Timer 1, the ADC is connected to the output response signal and the algorithm of determination of the amplitude described above is again started with td  T4. At the end of running this algorithm we obtain uOUT  um j,k, and tOUT  tm.  So the measurement procedure is finished with two bytes stored, which represent amplitudes maximal values of the input stimulating signal uIN and the output response signal uOUT, and one 16bit world also two bytes, which holds time delay between these signals m  tOUT  tIN.   Fig. 8.  Algorithm of the full measurement procedure Fig. 8 shows the full measurement procedure. It is implemented in the form of a function. It consists of an initial stage and two time calling of the amplitude determination function.  At the initial stage the Timer 1 is started with the value T written to its data register. This solution gives time for executing instructions making the ADC ready for the first measurement of the input signal. The first calling of the amplitude determination function determines the amplitude of the input signal uIN and the relative time for which this signal has a maximum value tIN. The second one provides the amplitude of the output signal uOUT and the time of occurrence of the maximum value tOUT. At the end the Timer 1 is stopped, the time delay m is calculated and variables uIN, uOUT, m are stored.   Fig. 9.  Flowchart of the amplitude determination function The algorithm of determination of the amplitude of the sinus wave Fig. 7 was implemented in the amplitude determination function. This function gets the variable tm keeping an initial value of time for which the algorithm starts. It returns variables which contain the amplitude of the signal um applied to the input of the ADC and the time tm of the maximum value of this signal. The variables u1, u2 and tmt contain temporary values of the voltage sample earlier measured, the currently measured voltage sample and time to activation of the next measurement of the voltage sample by the ADC. The variable ud keeps a value of an assumed precision of determination of the signal amplitude. If the difference between two last measured voltage samples is less then this value, the algorithm is stopped and variable um contains the voltage value of the last measured sample. The variable td represents the time distance to the next voltage sample. If the algorithm goes to the next iteration step, this value is divided by two. The bit variable direction appoints the direction of changes of the value tm. If it is equal 1, the time to the next measurement of the voltage sample is lengthened by addition of the td value, else this value is subtracted from this time. The value included in the variable tc is directly written to the Timer 1 Data Register TCNT1. The Timer 1 counts the time tmt diminished by the time tdelay needed to activate the ADC and to write a new value to the TCNT1 register. The idea of calculation of the time tc is shown in Fig. 11.  Fig. 10.  Illustration of the idea of calculating the time tc introduced to the Timer 1 This way of determination of moments of voltage samples is possible only for periodical signals. It is seen that the signal is sampled only one for the period T. The determination of the amplitude takes k1  k2  ...  kj periods T of the signal, where kj  the number of samples in the jth iteration step. So, this procedure occupies a long time. Because the measurement procedure is elaborated for using it for e.g. selftesting of analog parts of the mixed signal embedded systems and not for monitoring them, the duration time of the procedure is not critical. Moreover, the time distance between two samples measured by the ADC has to be greater than its long conversion time tADC minimum 65s. It is attended when tc  nT  tADC, where n  1, 2, .. . Our approach satisfies this criterion because the time tc is always greater then period T  1.12 ms. After calculation of the time tc the measurementADC function is called. This function returns the voltage sample of the signal measured by the ADC in the form of a single byte u2. Its flowchart is shown in Fig. 11. This flowchart consists of three parts. First part of the measurementADC function is realized in the main program. Its task is to synchronize the execution of the program with the moments of the sampling by the ADC to wait for the end of conversion of the ADC. The bit variable wait is used for this aim. It is set by the main part of the function and reset after the measurement by the ADC in its interrupt service.  Fig. 11.  Flowcharts of the measurementADC function and united interrupt services Two remaining parts are realized in the interrupt services of the Timer 1 Overflow Interrupt and the ADC Conversion Complete Interrupt.  The interrupt service of the Timer 1 is trivial  it only actualizes the data register of the new value of the time tc. The overflow of the Timer 1 auto triggers the ADC conversion in a hardware way. In the interrupt service of the ADC the conversion result is written to the variable u2 and the variable wait is reset. From Fig. 11 it is seen that the measurement algorithm is very simple. It is possible, because the ATmega16 microcontroller has a rich set of multifunctional, flexible end extended peripheral devices e.g. used by the method flexible TimerCounter 1 and especially an 8channel, 10bit ADC with start conversion by auto triggering on interrupt sources. It enables to elaborate a relatively simple algorithm of the measurement procedure. Using the interrupt system, for which each interrupt has a separate program vector in the program memory space, and using the ADC with source triggers TimerCounter1 Overflow, it is possible to count exactly times tc between successive voltage samples with the precision of a crystal oscillator connected to the microcontroller. The presented flowcharts Fig. 8, 9 and 11 of respective functions, where the measurement function calls two time the determinationAmplitude functions, which in turn calls the measurement function, show the hierarchic structure of the full measurement algorithm. Each of its levels the algorithm of the particular function is simple. Hence, the code of the complete measurement procedure is short and satisfies the accepted condition of minimization of space occupied in the program memory. 3.  AN ANALYSIS OF THE ACCURACY OF THE MEASUREMENT METHODS For the first measurement method, moments of beginning and end of the period T and the time delay  are determined by the analog comparator see Fig. 5. Its inaccuracy depends on the delay of a comparison and the threshold voltage which has to be equal to the offset voltage. Because we use only triggering of the TimerCounter 1 Input Capture function on the comparator output rising edge, the synchronization introducing a delay of 1  2 clock cycles 9 for all measurements is invariable and it compensates itself. So the measurement error  of determination of time delay  mainly depends on the deviation of the threshold reference voltage Uref of the analog comparator in relation to the offset voltage Uoffset of the signal. It is described by the following relation  amprefoffsetUUUTarcsin21                   2 where Uamp is the amplitude of the sine wave signal.  Fig. 12.  Graph of delay comparison of the analog comparator as a function of the difference between offset and threshold voltages In spite of the fact, that error   is about one grade smaller than its source difference between the threshold and offset voltage, what is shown in Fig. 12 with the graph of the relation 2, it is worth to reduce this error. We can do it in a simple way by the ADC measurement of the DC voltage Uoffset before proper measurements and by setting up Uref to this value. For both measurement approaches the accuracy of the measurement result of the ADC is equal to 1 LSB. It follows from the fact that the resolution of the ADC is 10bits 9, the absolute accuracy including INL, DNL, quantization error, gain and offset error by the ADCCLOCK  200 kHz is equal maximum 2.5 LSB, and we take into account only 8 high bits of the ADC conversion result.  The 16bit Timer 1 works with the precision of a crystal oscillator and it introduces only a quantization error. For the second measurement approach an error t of the time delay between the input and the output signal particularly depends on the assumed minimum difference ud between two lastmeasured voltage samples, for which the algorithm of the amplitude determination is finished. The relation 3 presents the relation between these magnitudes ampdUuTt2arcsin21                       3  Fig. 13.  Graph of the error of the determination of the moment for which the sine wave signal has its maximum value, as a function of the assumed precision of determination of the signal amplitude ud The graph of the relation 3 was drawn on Fig. 13. In this case it is seen that small changes of ud significantly influence the value of the error t. It results from the shape of the sine wave. Around the maximum value of the sinus function for the angle equal to 2 the characteristic is flat, so variations of the angle around 2 effect small changes of values of the sinus, as shown in Fig. 14.  Fig. 14.  Graph of the sinus wave around 2 illustrating dependences between the error t of determination of the moment of maximum value of the sinus function and the assumed precision of its determination ud The influence of the error t can be reduced in a few ways. For instance, when this measurement approach is used to selftesting of the analog part by the embedded system, we can determine the delay time with an 16bit accuracy the resolution of the Timer 1 and next we reduce this result to 8 high bits. In this way we adapt it to the detection and localization procedure, which bases on the fault dictionary consisting of only 8bit constants, e.g. 8. 3.  CONCLUSIONS The originality of the work presented in this paper is a new measurement procedure enabling the measurement of the circuit function of the analog part of the embedded system controlled by the microcontroller. This approach needs only internal resources currently implemented in each microcontroller the ADC, whose measurements are synchronized by the timer. Hence, this approach does not exact excess hardware. Additionally, it should be fully realized by embedded electronic systems in which it is implemented. Based on the internal devices of the microcontroller and its computing power we obtain a reconfigurable BIST. It is created only during the selftesting time. Apart from this time, the microcontroller and its internal devices perform normal functions. Hence, we considerably decrease the number of elements of the BIST which have to be added to the system, which allows to decrease production costs. This approach can be used everywhere measurements of circuit functions of analog circuits are needed. So, it can be not only used for fault detection and localization of single faults in the analog part of the mixedsignal embedded electronic systems, as presented in 8, but also e.g. for parametric identification of technical or biomedical objects modelled by electrical circuits. REFERENCES 1  European Design and Test Conference Conclusions, March 1996. 2  Sunter S. K., Nagi N. A Simplified PolynomialFitting Algorithm for DAC and ADC BIST Proc. Int. Test Conf., 1997, pp.389395. 3 Lubaszewski M., Mir S., Kolarik V., Nielsen Ch., Courtois B. Design of SelfChecking Fully Differential Circuits and Boards IEEE Transactions on Very Large Scale Integration VLSI Systems, vol. 8, no. 2, April 2000, pp. 113127. 4  Toczek W., Zielonko R. A measuring systems for fault detection via oscillation. Proc. XVI IMEKO World Congress. Vienna, Austria, 2000, vol. 6, pp. 287292. 5  FontRossello J., Ginard J., Isern E., Roca M., Garcia E. A digital bist for opamps embedded in mixedsignal circuits by analysing the transient response. Forth IEEE International Caracas Conference on Devices, Circuits and Systems, Aruba, 2002, pp. IO121  IO125. 6 Czaja Z., Zielonko R. On fault diagnosis of analogue electronic circuits based on transformations in multidimensional spaces, Measurement, 2004, Vol. 35, No. 3, pp. 293301. 7 Czaja Z., Zielonko R. Fault diagnosis in electronic circuits based on bilinear transformation in 3D and 4D spaces, IEEE Trans. on Instrumentation and Measurement, 2003, Vol. 52, No.1, pp. 97102. 8 Czaja Z., Zaski D. Implementation of an inputoutput method of diagnosis of analog electronic circuits in embedded systems, Proc. IMEKO TC10, Budapest, Hungary, 2005, pp.145150. 9 Atmel Corporation, 8bit AVR microcontroller with 16k Bytes InSystem Programmable Flash, ATmega16, ATmega16L, PDF file, 2003.
