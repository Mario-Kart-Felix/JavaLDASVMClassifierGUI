Embedded CyberPhysical Anomaly Detection inSmart MetersMassimiliano Raciti, Simin NadjmTehraniDepartment of Computer and Information Science, Linkping UniversitySE581 83 Linkping, Swedenmassimiliano.raciti,simin.nadjmtehraniliu.seAbstract. Smart grid security has many facets, ranging over a spectrum from resisting attacks aimed at supervisory and control systems,to end user privacy concerns while monitored by the utility enterprise.This multifaceted problem also includes vulnerabilities that arise fromdeployment of local cyberphysical attacks at a smart metering location,with a potential to a manipulate the measured energy consumption, andb being massively deployed aiming at destabilisation. In this paper westudy a smart metering device that uses a trusted platform for storageand communication of metering data, and show that despite the hardcore security, there is still room for deployment of a second level of defence as an embedded realtime anomaly detector that can cover boththe cyber and physical domains.1 IntroductionLimitations of todays power networks, combined with the need for sustainableenergy resources has led to promotion of smart grid architectures 1. Thesepromise higher reliability due to the inherently distributed nature of productionand distribution, higher efficiency due to incorporation of mass scale sensors andfaster management dynamics, and finegrained adaptation to local failures andoverloads. The large scale deployment of such networks is, however, dependent onexploitation of standard IPbased protocols, commodity sensors and actuators,and the ability of vendors to create a trusted environment on which adaptationsof supply and demand can be based. The notion of cyberphysical systems, aiming to cover the virtually global and locally physical 2 is nowadays used evento encompass smart grids as an illustrating example.Security is one of the less developed attributes in the cyberphysical domain.While security is indeed part of the grand challenges facing large scale development of cyberphysical systems, the focus of smart grid security is increasinglyon threats to control systems 3, or serving the privacy of the end user whilebeing subject to monitoring 4. In this paper we address the risk of manipulations at the enduser level, even when a trusted infrastructure is assumed to bepresent at the smart metering end points.The contributions of this paper are as follows1. We analyse the design of a smart meter which uses trusted computing technology to enforce strong security requirements, and we show the existenceof a weakness in the forthcoming endnodes, justifying realtime anomalydetection.2. We propose an architecture for embedded anomaly detection for both thecyber and physical domains in smart meters and create an instance of aclusteringbased anomaly detection algorithm in a prototype under industrialdevelopment.3. We illustrate the detection of cyber attacks, which in principle can be scriptbased and massively deployed, and provide the infrastructure owner withreliable alerts.The rest of the paper is organised as follows Section 2 discusses the relatedwork in this field, Section 3 presents the smart metering infrastructure, Section4 discusses our proposed anomaly detection architecture and Section 5 showsthe detection results on some cyberattacks performed on a prototype of a smartmeter.2 Related WorkSmart grid cyber security has been a hot topic in recent years, with both researchers, industry and organisations involved in the definition of security requirements and standard solutions 57.The Advanced Metering Infrastructure AMI is particularly vulnerable tocyber attacks, and careful attention has been given to its specific security requirements analysis 8. Confidentiality, privacy, accountability, integrity andavailability are critical requirements for accurate electricity billing and realtimepower demand estimation. Cleveland 8 points out that encryption alone is notthe solution that matches all the requirements, and automated diagnostics, physical and cyber intrusion detection can be means of preventing loss of availability.Intrusion detection has been considered as a possible defence strategy inAMIs. Berthier et al. 9, 10 highlight the need for realtime monitoring in AMIsystems. They propose a distributed specificationbased approach to anomalydetection in order to discover and report suspicious behaviours during networkor host operations. The advantage of this approach, which consists of detectingdeviation from highlevel models specifications of the system under study, isthe effectiveness on checking whether the system follows the specified securitypolicies. The main disadvantages are the high development cost and the complexity of the specifications.Kush et al. 11 analyse the gap between conventional IDS systems and thespecific requirements for smart grid systems. They find that an IDS must support legacy hardware and protocols, be scalable, standard compliant, adaptiveto changes, deterministic and reliable. They evaluate a number of existing IDSapproaches for SCADA systems, the approach by Berthier et al. and few conventional IDS systems that could be applied to AMIs, and they verify that noneof them satisfy all the functional requirements.Beside cyber attacks, physical attacks are also a major cause of concern. Electricity theft is the main motivation that induces unethical customers to tamperwith the meters, and the minimisation of energy theft is a major reason whysmart metering practice has been initiated. McLaughlin et al. 12, 13, however,show that smart meters offer even more vulnerabilities than the old electromechanical meters. Physical tampering, password extraction, eavesdropping andmeter spoofing can be easily performed with commodity devices.An approach for discovering theft detection with smart metering data is discussed in Kadurek et al. 14. They devise two phases during the first phase theenergy balance at particular substations of the distribution systems is monitored.If the reported consumption is different from the measured one, an investigationphase aims as locating the point where the fraud is taking place.In our environment the security requirements for AMI are fulfilled usingtrusted computing technology, complemented by our proposed embedded anomalydetection architecture that takes into account both the cyber and the physicaldomain.3 The Trusted Smart Metering InfrastructureThe Trusted Sensor Network TSN 15 is a smart metering infrastructure defined as a use case within the EU FP7 SecFutur Project 16. The main goalFig. 1 Trusted Smart Metering Infrastructure 15of this solution is to ensure authenticity, integrity, confidentiality and accountability of the metering process in an environment where multiple organisationscan operate and where legal calibration requirements must be fulfilled 15. Thisgoal is achieved by a careful definition of the security requirements supported bytrusted computing techniques. As depicted in Figure 1, a Trusted Sensor ModuleTSM is located in each household. The energy measurements produced by oneor more sensors are encrypted and certified by the TSM, which sends them toa Trusted Sensor Module Collector TSMC. This component gathers the datacoming from several TSMs and relays it to the operator server infrastructurefor its storage. Through the general purpose network several organisations canget remote access to the functionality of the metering system for installation,configuration and maintenance, but strict access policies and accountability ofthe actions are enforced.A smart meter in this architecture is called Trusted Meter TM, and it canbe composed of one of more physical sensors, one or more TSMs and one TSMC.A detailed description of the architecture is presented elsewhere 15.MixedModeTM, a partner company within the SecFutur project, has developed a prototype of a Trusted Meter, described in the next section.3.1 Trusted Meter PrototypeFig. 2 Trusted MeterThe prototype of a TM is composed of one physical sensor and includes thefunctionalities of a TSM and a TSMC. The sensor is an ADE7758 integratedcircuit, which is able to measure the accumulated active, reactive and apparentpower. The functionality of the sensor is accessible via several registers that canbe read or written through its interface to the Serial Peripheral Interface SPIbus. There is a variety of registers that can be accessed for reading out energymeasurements, configuring the calibration parameters, operational states etc.The sensor is then interfaced with an OMAP 35x system where the functionalities of the TSM and TSMC are implemented in software, with the additionof specialised hardware, namely Trusted Platform Module TPM, that providesthe trusted computing functionalities. The system, running ngstrm Linux,uses secure boot to ensure that the hardware and software modules are not corrupted and encryption is used to send out the readings to the operator servers.3.2 ThreatsAfter a careful study of the security requirements of the system, the appliedsecurity mechanisms and the design of the meter prototype, we came up withthe following observations The consumption measurements, certificates, and credential recorded in theprocessor module OMAP 35x will not be subject to change by malware orexternal applications due to the use of TPM technology, which also preventstypical smart meter vulnerabilities reported in an earlier work 12. The metering data that is sent out to the operator servers is encrypted bythe application, hence secure while in transmission. The weakest point in the system is represented by the unprotected physicalconnection between the sensor and the OMAP 35x system where the TSMand TSMC functionalities are implemented.The main threat is hence represented by potential maninthe middle attackson the SPI bus that affect the values of data or commands transmitted, asdepicted in Figure 3.a Manipulation of consumption valuesb Manipulation or injection of controlcommandsFig. 3 Possible attack on the communication busA possible solution would be again based on encryption of the messages priorto the transmission on the SPI bus. This could be applicable in the cases whenthe sensor and the TSM are two physically separate modules, but when it comesto an embedded system, encryption would dramatically increase the complexityof the sensor circuitry, that must be kept cheap due to the large scale deployment.This analysis shows the need for realtime monitoring for intrusion detectionis still present although trusted platforms offer higher level of protection thanearlier solutions. This motivates proposing an embedded anomaly detection aspotential technology to explore.4 Embedded Anomaly DetectionThe proposed embedded anomaly detection architecture is devised to be includedin the functionality of the Trusted Meter. Figure 4 illustrates the main components of the architecture. It consists of five modules a data logger, a data preprocessor, two anomaly detection modules and an alert aggregator. The data loggerFig. 4 Proposed CyberPhysical Anomaly Detection Architectureis in charge of listening for communication events and data exchange throughthe sensorTSM channel. It will record both the cyber domain information, i.e.packet headers or connections, as well as the physical energy measurements.The data preprocessor is in charge of transforming the raw signals detectedon the channel into feature vectors that can be fed to the anomaly detectionmodules for evaluation of current state.Anomaly detection consists of two modules one is used for the cyber layer,i.e. the communication protocol on the SPI bus in the prototype meter, whilethe second is used to detect anomalies on the physical layer, the actual energyconsumption that is reported by the sensor. The motivation for this distinctionis the need for having two different time scales on the state estimation in the twodomains while the cyber communication can be monitored and suspicious eventsdetected within seconds, anomalies on the physical domain need to be discoveredin the order of days or weeks. This is due to the fact that load profiles changedetection is only meaningful when based on a sufficiently long time window. Thetwo modules complement each other while command injection on the bus can bedetected by the cyber layer anomaly detector, consumption data manipulationleading to changing consumption statistics can be detected by the physical layeranomaly detector.The last component of the architecture, the alert aggregator, takes as inputthe alarms generated by the two anomaly detector modules and decides whetheranomalous behaviour should be reported to the central system.In the following sections we will describe the modules in depth and presenttheir implementation in our current test system.4.1 Data LoggerIn the prototype meter, the unprotected communication channel between thesensor and the TSMTSMC module is the SPI bus. The SPI communicationis always initiated by the processor in the OMAP 35X system who writes,in the communication register of the sensor, a bit that specifies whether theoperation is a read or a write command, followed by the address of the registerthat needs to be accessed. The second part of the communication is the actualdata transfer from or to the addressed register of the sensor. The application thatimplements the TSM and TSMC functionalities performs a energy reading cycleevery second, sending calibrations or configuration commands when required.Our bus logger records the following information the timestamp of the operation, the command type read or write, the register involved in the operationof the value that is read or written. In our experimental setup, as describedlater, the data logged at the driver level of the SPI interface of the TSMTSMCside sufficed for our evaluation. However, bus messages should be sniffed andlogged by an external element in order to record all the commands received bythe ADE7758 sensor, and its deployment will be considered in the design of thenext version of the prototype.4.2 Data Preprocessing and Feature ExtractionThe data preprocessor receives records in the format presented in the previoussection, and produces vectors of features that will be processed by the anomalydetectors. A common data preprocessor for both domains avoids processing thereceived data twice. The features selected are numerical variables that all together represent the normal operation of the system. For the cyber domain,these are based on information regarding the frequency and types of operationscarried out on the SPI bus during a period of observation time I. There are threecategories of features Operation type percentage of number of read or write operations performed in the period of observation I. An additional feature counts the number of times the readonly registers are accessed, which is useful to capturethe fact that most of the time every second in our case the communicationis performed to read out energy measurements. Category type percentage of the number of times the registers of the following categories are accessed in the period of observation I  reading, configuration, interrupt, calibration, event, info. The first category includes registersused for accumulation of active, reactive and apparent energy accumulationfor the three different phases. Register categorised as configuration are thoseused for configuring different operational parameters of the energy measurement. Registers in the category interrupt are interrupt status flags. Registersincluded in the event category are used to store information on events suchas voltage or current peak detection etc. The category calibration, groups theimportant registers used to calibrate the different parameters of the sensor.Finally, the info category groups registers where checksums and the versionof the sensor are stored. Register frequencies usage frequency of each individual register addressedin the period of observation I.These features are designed to characterise the typical communication patterns,therefore anomalous communication sequences or register access rates should bediscovered by the anomaly detector.In the physical domain, commonly used indices for customers characterisation, based on load profiles, can be utilised as features. These include dailyindices, as the widely used indices proposed in Ernoult et al. 17, such as thenonuniformity coefficient   PminPmax , the fillup coefficient  PavgPmax, the modulation coefficient at peak hours MCph Pavg,phPavgand the modulation coefficientat nonpeak hours MCoph Pavg,ophPavg, where Pmin is the minimum power demand reported during the day, Pmax is the maximum power demand, Pavg isthe average power demand, Pavg,ph is the average power demand during the peakhours and Pavg,oph is the power demand during the offpeak hours. More refinedindices that take into account weekly patterns working days and weekends canbe added, as those described in Chicco et al. 18.4.3 Cyberlayer Anomaly Detection AlgorithmThe sensorprocessor communication is based on a series of messages exchangedthrough the bus. In this context, the set of possible combinations is not verylarge, due to the fact the set of registers accessible is bounded. The behaviourin terms of the commands sequences, captured by the features selected, can beconsidered as data points that fall into certain regions of the multidimensionalfeatures space. In order to identify the good behaviour, an algorithm that isable to identify these regions and consider them as the normality space wouldbe needed.Therefore, we have adopted and embedded an instance of a clusteringbasedanomaly detection algorithm 19 that uses a smart indexing strategy and istherefore computationally efficient. Section 5 presents the evaluation of this algorithm.4.4 Physicallayer Anomaly Detection AlgorithmThe features available for modelling the physical domain suggest that whenthe load profile changes due to an eventual attack, the statistics over a longperiod would be affected. A lightweight change detection algorithm can thereforebe embedded into the smart meter. A statistical anomaly detector using theindicators described in Section 4.2 has been developed. However, due to absenceof long term data and ability to train and test the anomaly detector on consumedelectricity profiles, we have focused development and tests on the cyber levelattacks.4.5 Alert AggregatorThe last component of the architecture is in charge of collecting the alerts generated by the anomaly detector modules, and performing aggregation in orderto reduce the number of alarms sent to the central operator. The alert aggregation module can gather additional information in order to provide statisticsthat show the evidence of an attack or the anomalous conditions. This createsa smart meter health although individual analysis would still require a lot of effort and privacy concerns would hinder its careless deployment. However, thiscan be useful when investigating areas in which nontechnical losses i. e. lossesthat are not caused by transmission and distribution operations are detected,supporting for example localisation strategies as in 14. Future works includefurther investigations and privacyaware development of this module.5 EvaluationIn this section we present the evaluation of the anomaly detection on a number ofattacks performed in the cyber domain. We start presenting the methodology tocollect the data for evaluation, then we introduce the cyber attacks we performedand finally we show the outcomes of the clusteringbased anomaly detectionalgorithm.5.1 Data collectionIn order to obtain data for training and testing the anomaly detection algorithm,the trusted meter prototype has been installed in a household and real energyconsumption measurements have been collected during a period of two weeks inJanuary 2012. Although this frame of time is not long enough to capture normality for the physical domain, it is representative enough for the cyber domain,where a 187MB data log file has been collected. The log, produced by the datalogger module as explained in section 4.1, is composed of bus communicationtransactions that involve several registers for energy reading, sensor configurations, calibration commands and sensor events. The energy reading operationsare performed with a period of one second, and they are predominant in thedataset. The data preprocessor, as presented in section 4.2, gathers the transactions during a period of observation I which has been set to 10 seconds, andproduces a feature vector that is processed by the anomaly detection algorithm.5.2 Cyber attacks and data partitioningFour types of attack have been implemented1. Data manipulation attack in this scenario, the attacker performs a maninthemiddle attack in which the values of the registers involved in theenergy measurement are lowered. This can be easily done by overwriting thesignal on the bus on every reading cycle.2. Recalibration attack this commands is injected on the bus in order tochange the value of some registers that hold calibration parameters, causing the sensor to perform erroneous measurement adjustments during itsoperation.3. Reset attack this command causes the content of the energy accumulationregisters to be wiped out. It has to be executed within every reading cyclein order to reduce the reported energy consumption. In our scenario, weexecuted it with a period of one second, interleaving it with the period ofthe measurement process.4. Sleep mode attack this command puts the sensor into sleep mode, e.g. nomeasurements are taken. While in sleep mode, the sensor SPI interface stillreplies to the commands executed by the processor module, but the energyconsumption is not accumulated by the sensor.In our evaluation, we tested the attacks 2 to 4, since attack 1 does not produce new messages on the bus and it would only be detectable by the physicallayer anomaly detector. The attacks were first implemented at application level,through the SPI interface drivers of the processor module. Since the data wascollected in an attackfree scenario, a script has been implemented to weave theattack information into the clean data. Our traces consist of two weeks of logsin which 23 of the data represent normal conditions, and the remaining 13is affected by one attack at the time, generating therefore 3 different testingtraces. However, a physical hardware that can implement such attacks on thebus SecFat is under development in the SecFutur project.The anomaly detector algorithm is therefore trained with the feature vectorsobtained by the first third of the data, while we tested with the other 3 traceswhich contain the remaining third of normal data and the third of data underattack. When the data preprocessor computed the feature vectors, we manuallyset an oracle bit to indicate whether the features are affected by an attack ornot. This will be helpful for comparison when evaluating the outcomes of theanomaly detection algorithm.5.3 ResultsDuring our evaluation, we have tuned the two classical parameters of the clusteringbased anomaly detection algorithm which need to be configured manually in order to create a good normality model and optimise the search efficiency. Theseare the maximum number of clusters M, and a cluster centroid distance threshold E, that is used when determining whether a new data point falls within itsclosest cluster or not. The optimal number of clusters typically depends on thedistribution of the input data into the multidimensional space. The threshold isalso important, since during realtime monitoring it determines whether a newfeature vector belongs to any preexisting cluster or not. Therefore, in order toselect a suitable combination of the two parameters, the outcomes of the detection were explored with M ranging from 10 to 100, and E ranging from 1 to2.5.The metrics used for evaluating the detection algorithm were the detectionrate DR, calculated from the percentage of feature vectors during the attackthat are correctly classified as anomalous, and the false positive rate FPR,which measures the percentage of normal observations that are erroneously classified as anomalous.Our results show that the algorithm does not build a correct partitioning ofthe normality data when M is set to 10 and 20 with all the possible combinationsof E. In the detection phase, all the observations with or without attacks areclassified as anomalous, leading to 100 DR but with a 100 FPR rate. Anoptimal partitioning of the normality data is found when M is set to at least30. In this case, the algorithm uses 18 clusters to model the data, and for everyconfiguration of E in the range between 1 and 2 we get 100 DR with nofalse positives for all three types of attacks. In the cases when E is over 2 weallow a very large threshold and the detection rate is reduced to zero for therecalibration attack, since it is the attack type that is more similar to normalconditions where recalibration takes place in the training period. The results aresimilar when increasing M up to 100. This means that the algorithm finds 18clusters to be the best number for modelling the normality data.6 Conclusion and future workIn this paper we have analysed the vulnerabilities of a recently designed smartmetering infrastructure. Although confidentiality, authenticity, accountability,integrity and privacy are provided by the use of TPM technology embedded intosmart meters, some vulnerabilities persist and realtime monitoring for cyber andphysical tampering attacks is still a security solution that must be consideredwhen designing new smart meters. Therefore, we have explored deployment ofa lightweight embedded anomaly detection architecture that takes into accountboth cyber and physical domains and implemented and evaluated part of thisarchitecture on a smart meter prototype. The evaluation performed on attacksin this psuedoreal settings has shown that the algorithm is able to efficientlydetect several types of attacks without emitting any false positive.Further development will target the physical layer anomaly detector andthe module that combines the outcomes of the detection on both domains andprovides a smart meter health indicator to provide the utility company with amore accurate nontechnical loss analysis.AcknowledgmentsThis work has been financially supported by the Swedish National GraduateSchool in Computer Science CUGS and the EU FP7 SecFutur Project. Supportby Niklas Carstens and Maurits Broxvall, from MixedMode, collaborating in theSecFutur project, is gratefully acknowledged.References1. Fang, X., Misra, S., Xue, G., Yang, D. Smart gridthe new and improved powergrid A survey. Communications Surveys Tutorials, IEEE PP99 2011 1 372. Rajkumar, R.R., Lee, I., Sha, L., Stankovic, J. Cyberphysical systems the nextcomputing revolution. In Proceedings of the 47th Design Automation Conference.DAC 10, ACM 2010 7317363. Alcaraz, C., Fernandez, G., Carvajal, F. Security aspects of SCADA and DCSenvironments. In Lopez, J., Setola, R., Wolthusen, S., eds. Critical InfrastructureProtection. Volume 7130 of Lecture Notes in Computer Science. Springer Berlin Heidelberg 2012 1201494. NISTIR 7628 Guidelines for Smart Grid Cyber Security Vol.2, Privacyand the Smart Grid, httpcsrc.nist.govpublicationsnistirir7628nistir7628vol2.pdf, accessed Jun. 2012.5. NISTIR 7628 Guidelines for Smart Grid Cyber Security Requirements, httpcsrc.nist.govpublicationsnistirir7628introductiontonistir7628.pdf, accessed Jun. 2012.6. Pallotti, E., Mangiatordi, F. Smart grid cyber security requirements. In Environment and Electrical Engineering EEEIC, 2011 10th International Conferenceon. 2011 1 47. Lu, Z., Lu, X., Wang, W., Wang, C. Review and evaluation of security threatson the communication networks in the smart grid. In Military CommunicationConference, 2010  MILCOM 2010. 2010 1830 18358. Cleveland, F. Cyber security issues for advanced metering infrastructure ami. InPower and Energy Society General Meeting  Conversion and Delivery of ElectricalEnergy in the 21st Century, 2008 IEEE. July 2008 1 59. Berthier, R., Sanders, W., Khurana, H. Intrusion detection for advanced metering infrastructures Requirements and architectural directions. In Smart GridCommunications SmartGridComm, 2010 First IEEE International Conferenceon. Oct. 2010 350 35510. Berthier, R., Sanders, W. Specificationbased intrusion detection for advancedmetering infrastructures. In Dependable Computing PRDC, 2011 IEEE 17thPacific Rim International Symposium on. Dec. 2011 184 19311. Kush, N., Foo, E., Ahmed, E., Ahmed, I., Clark, A. Gap analysis of intrusiondetection in smart grids. In Valli, C., ed. 2nd International Cyber ResilienceConference, secau  Security Research Centre August 2011 384612. McLaughlin, S., Podkuiko, D., McDaniel, P. Energy theft in the advanced metering infrastructure. In Proceedings of the 4th international conference on Criticalinformation infrastructures security. CRITIS09, SpringerVerlag 2010 17618713. McLaughlin, S., Podkuiko, D., Miadzvezhanka, S., Delozier, A., McDaniel, P.Multivendor penetration testing in the advanced metering infrastructure. In Proceedings of the 26th Annual Computer Security Applications Conference. ACSAC10, ACM 2010 10711614. Kadurek, P., Blom, J., Cobben, J., Kling, W. Theft detection and smart metering practices and expectations in the netherlands. In Innovative Smart GridTechnologies Conference Europe ISGT Europe, 2010 IEEE PES. 2010 1615. Broxvall, M. Metering devices with legal calibration requirements, Deliverable D2.1, httpwww.secfutur.euWP2DeliverablesD2.1DeliverableD21.pdf, accessed May 2012.16. EU SecFutur FP7 Project httpwww.secfutur.eu, accessed Jun. 2012.17. Ernoult, M., Meslier, F. Analysis and forecast of electrical energy demand. InRevue gnrale de llectricit. Volume 4. 198218. Chicco, G., Napoli, R., Postolache, P., Scutariu, M., Toader, C. Electric energycustomer characterisation for developing dedicated market strategies. In PowerTech Proceedings, 2001 IEEE Porto. Volume 1. 2001 6 pp. vol.119. Burbeck, K., NadjmTehrani, S. Adaptive realtime anomaly detection with incremental clustering. Information Security Technical Report  Elsevier 121 20075667
